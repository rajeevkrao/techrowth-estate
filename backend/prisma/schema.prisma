// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}


model User {
  id                String              @id @default(auto()) @map("_id") @db.ObjectId
  email             String              @unique
  username          String              @unique
  password          String
  avatar            String?
  credits           Int                 @default(0)
  role              UserRole            @default(USER)
  isVerified        Boolean             @default(false)
  createdAt         DateTime            @default(now())
  posts             Post[]
  savedPosts        SavedPost[]
  chats             Chat[]              @relation(fields: [chatIDs], references: [id])
  chatIDs           String[]            @db.ObjectId
  transactions      Transaction[]
  creditTransactions CreditTransaction[]
}

enum UserRole {
  USER
  AGENT
  ADMIN
}


model Post {
  id                String              @id @default(auto()) @map("_id") @db.ObjectId
  title             String
  price             Int
  images            String[]
  address           String
  city              String
  bedroom           Int
  bathroom          Int
  latitude          String
  longitude         String
  type              Type
  property          Property
  status            PostStatus          @default(DRAFT)
  viewCount         Int                 @default(0)
  isFeatured        Boolean             @default(false)
  expiresAt         DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  user              User                @relation(fields: [userId], references: [id])
  userId            String              @db.ObjectId
  postDetail        PostDetail?         @relation("PostToPostDetail")
  savedPosts        SavedPost[]         @relation("PostToSavedPost")
  creditTransactions CreditTransaction[]
}

enum PostStatus {
  DRAFT
  ACTIVE
  EXPIRED
  SOLD
  RENTED
}

enum Type {
  buy
  rent
}

enum Property {
  apartment
  house
  condo
  land
}


model PostDetail {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  desc String
  utilities String?
  pet String?
  income String?
  size Int?
  school Int?
  bus Int?
  restaurant Int?
  post Post @relation("PostToPostDetail", fields: [postId], references: [id], onDelete: Cascade) // Specify onDelete here
  postId String @db.ObjectId @unique
}


model SavedPost {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  user        User     @relation(fields: [userId], references: [id])
  post        Post     @relation("PostToSavedPost", fields: [postId], references: [id], onDelete: Cascade) // Keep onDelete here
  userId      String   @db.ObjectId
  postId      String   @db.ObjectId
  createdAt   DateTime @default(now())
  @@unique([userId, postId])
}


model Chat {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  users     User[]    @relation(fields: [userIDs], references: [id])
  userIDs   String[]  @db.ObjectId
  createdAt DateTime  @default(now())
  seenBy    String[]  @db.ObjectId
  messages  Message[]
  lastMessage String?
}


model Message {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  text      String
  userId    String
  chat      Chat     @relation(fields: [chatId], references: [id])
  chatId    String   @db.ObjectId
  createdAt DateTime @default(now())
}


model Transaction {
  id                 String            @id @default(auto()) @map("_id") @db.ObjectId
  user               User              @relation(fields: [userId], references: [id])
  userId             String            @db.ObjectId
  razorpayOrderId    String            @unique
  razorpayPaymentId  String?           @unique
  razorpaySignature  String?
  amount             Int               // Amount in paise (â‚¹500 = 50000 paise)
  credits            Int               // Number of credits purchased
  packageName        String            // Basic, Pro, Premium
  status             TransactionStatus @default(PENDING)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}


model CreditTransaction {
  id          String              @id @default(auto()) @map("_id") @db.ObjectId
  user        User                @relation(fields: [userId], references: [id])
  userId      String              @db.ObjectId
  post        Post?               @relation(fields: [postId], references: [id])
  postId      String?             @db.ObjectId
  credits     Int                 // Positive for purchase, negative for spend
  type        CreditTransactionType
  description String              // e.g., "Published property", "Purchased Basic package"
  createdAt   DateTime            @default(now())
}

enum CreditTransactionType {
  PURCHASE
  SPEND
  REFUND
  ADMIN_ADJUSTMENT
}


model CreditPackage {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String   @unique // Basic, Pro, Premium
  price       Int      // In paise
  credits     Int      // Number of credits
  description String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}